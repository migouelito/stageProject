{% extends 'base/base.html' %}

{% block content %}
<h1 class="titre">Suivez en temps r√©el votre b√©tail</h1>

<div id="map" style="width: 100%; height: 500px;"></div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    const userId = "{{ user_id }}";
    console.log('user_id r√©cup√©r√©:', userId);
    
    // D√©clarer la variable trackerMarkers
    const trackerMarkers = {};

    const map = L.map('map').setView([0, 0], 2); // Position par d√©faut

    // D√©finir les tuiles de la carte
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    // Fonction pour obtenir l'ic√¥ne verte
    function getGreenIcon() {
        return new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    // Connexion au WebSocket pour r√©cup√©rer les positions des capteurs
    // Assurez-vous que cette URL est √† jour et correspond √† votre serveur actuel
    const socket = new WebSocket(`wss://{{ MY_GLOBAL_VARIABLE }}/ws/positions/?user_id=${userId}`);

    socket.onopen = function () {
        console.log('WebSocket connect√© !');
    };

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const trackerId = data.tracker_id || 'default';
        const icon = getGreenIcon();

        if (trackerMarkers[trackerId]) {
            trackerMarkers[trackerId].setLatLng([data.latitude, data.longitude]);
            if (trackerMarkers[trackerId]._popup) {
                trackerMarkers[trackerId]._popup.setContent(`üêÑ B≈ìuf ${trackerId}`);
            }
        } else {
            const marker = L.marker([data.latitude, data.longitude], {
                icon: icon,
                riseOnHover: true
            }).addTo(map);

            marker.bindPopup(`üêÑ B≈ìuf ${trackerId}`, { autoPan: false });
            trackerMarkers[trackerId] = marker;
        }

        // D√©placer la carte vers la position du tracker
        map.setView([data.latitude, data.longitude], 14); // Zoom am√©lior√© pour plus de d√©tails
    };

    socket.onerror = function (error) {
        console.error('WebSocket Error:', error);
    };

    socket.onclose = function (event) {
        console.warn('WebSocket ferm√©:', event.code);
    };

    // ----------------------------
    // Affichage des zones de s√©curit√©
    // ----------------------------

    const zonesData = JSON.parse(`{{ zones_data_json|escapejs }}`);

    zonesData.forEach(zone => {
        const forme = zone.forme;

        if (forme === 'cercle' && zone.latitude && zone.longitude && zone.rayon) {
            L.circle([zone.latitude, zone.longitude], {
                radius: zone.rayon,
                color: 'blue',
                fillOpacity: 0.2
            }).addTo(map).bindPopup(`Zone #${zone.id} (Cercle)`);
        }
        else if ((forme === 'rectangle' || forme === 'carre') && zone.coin1_lat) {
            const latlngs = [
                [zone.coin1_lat, zone.coin1_lon],
                [zone.coin2_lat, zone.coin2_lon],
                [zone.coin3_lat, zone.coin3_lon],
                [zone.coin4_lat, zone.coin4_lon],
                [zone.coin1_lat, zone.coin1_lon]
            ];
            L.polygon(latlngs, {
                color: 'orange',
                fillOpacity: 0.2
            }).addTo(map).bindPopup(`Zone #${zone.id} (${forme})`);
        }
        else if (forme === 'triangle' && zone.coin1_lat) {
            const latlngs = [
                [zone.coin1_lat, zone.coin1_lon],
                [zone.coin2_lat, zone.coin2_lon],
                [zone.coin3_lat, zone.coin3_lon],
                [zone.coin1_lat, zone.coin1_lon]
            ];
            L.polygon(latlngs, {
                color: 'purple',
                fillOpacity: 0.2
            }).addTo(map).bindPopup(`Zone #${zone.id} (Triangle)`);
        }
        else if (forme === 'polygon' && zone.coins) {
            try {
                const coords = JSON.parse(zone.coins);
                const latlngs = coords.map(pt => [pt.lat, pt.lon]);
                if (latlngs.length > 2) {
                    L.polygon(latlngs, {
                        color: 'green',
                        fillOpacity: 0.2
                    }).addTo(map).bindPopup(`Zone #${zone.id} (Polygone)`);
                }
            } catch (e) {
                console.error("Erreur de parsing polygon:", e);
            }
        }
        else if (forme === 'marker' && zone.latitude && zone.longitude) {
            L.marker([zone.latitude, zone.longitude])
                .addTo(map)
                .bindPopup(`Zone #${zone.id} (Point)`);
        }
    });

    // R√©cup√©rer la position g√©ographique de l'utilisateur avec une meilleure pr√©cision
    if (navigator.geolocation) {
        // Options am√©lior√©es pour la g√©olocalisation
        const options = {
            enableHighAccuracy: true,  // Utiliser GPS de haute pr√©cision si disponible
            timeout: 10000,            // Attendre jusqu'√† 10 secondes
            maximumAge: 0              // Toujours obtenir une position fra√Æche
        };
        
        navigator.geolocation.getCurrentPosition(function(position) {
            const userLat = position.coords.latitude;
            const userLon = position.coords.longitude;
            const accuracy = position.coords.accuracy;
            
            console.log(`Position de l'utilisateur : ${userLat}, ${userLon}`);
            console.log(`Pr√©cision: ${accuracy} m√®tres`);
            
            // Centrer la carte sur la position avec un niveau de zoom appropri√©
            map.setView([userLat, userLon], 15);
            
            // Ajouter un marqueur pour la position
            L.marker([userLat, userLon])
                .addTo(map)
                .bindPopup("Votre position actuelle");
                
            // Ajouter un cercle indiquant la pr√©cision
            L.circle([userLat, userLon], {
                radius: accuracy,
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.2
            }).addTo(map).bindPopup(`Pr√©cision: ¬±${accuracy}m`);
            
        }, function(error) {
            let errorMessage = "Erreur de g√©olocalisation: ";
            
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += "Permission de g√©olocalisation refus√©e. Veuillez autoriser l'acc√®s √† votre position.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += "La position g√©ographique est indisponible. V√©rifiez votre GPS ou connexion r√©seau.";
                    break;
                case error.TIMEOUT:
                    errorMessage += "La demande de g√©olocalisation a expir√©. Essayez √† nouveau.";
                    break;
                case error.UNKNOWN_ERROR:
                    errorMessage += "Une erreur inconnue est survenue.";
                    break;
            }
            
            console.error(errorMessage);
            alert(errorMessage);
            
            // Afficher un message sur la carte en cas d'erreur
            L.popup()
                .setLatLng(map.getCenter())
                .setContent(errorMessage)
                .openOn(map);
                
        }, options);
    } else {
        const message = "La g√©olocalisation n'est pas support√©e par ce navigateur. Utilisez un navigateur plus r√©cent.";
        alert(message);
        console.error(message);
    }
</script>

<style>
    .titre h1 {
        font-size: 30px;
        color: #008000;
    }
    .titre {
        font-size: 30px;
        color: #008000;
        margin: 0 0 15px 0;
        padding-left: 0;
    }
    #map {
        width: 100%;
        height: 80vh; /* Ajust√© pour une meilleure visibilit√© */
        border: 2px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
</style>
{% endblock %}