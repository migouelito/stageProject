{% extends 'base/base.html' %}

{% block content %}
<style>
  
    .container-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 30px;
        padding-bottom: 10px;
        position: relative;
        flex-wrap: wrap;
    }

    .container-header::before {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        width: 100%;
        height: 6px;
        background-color: black;
        animation: loadBar 1s forwards;

    }

    @keyframes loadBar {
        0% { width: 0%; }
        100% { width: 100%; }
    }
    
    .container-header h1 {
        font-size: 30px;
        color: #008000;
        margin: 0 0 15px 0;
        padding-left: 0;
    }

    /* Carte Leaflet */
    #map {
        height: calc(100vh - 100px);  /* Enl√®ve la hauteur de l'en-t√™te */
        width: 100%;
        border: 2px solid #ddd;
        border-radius: 5px;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
</style>

<div class="container-header">
    <h1>Suivez en temps r√©el votre b√©tail</h1>
    <!-- Barre de chargement juste en dessous du titre -->
</div>

<div id="map" style="width: 100%; height: 500px;"></div>

<!-- Leaflet CSS & JS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
    const userId = "{{ user_id }}";
    console.log('user_id r√©cup√©r√©:', userId);

    const trackerMarkers = {};
    const map = L.map('map').setView([0, 0], 2); // Position par d√©faut

    // D√©finir les tuiles de la carte
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

    function getGreenIcon() {
        return new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-green.png',
            shadowUrl: 'https://unpkg.com/leaflet@1.7.1/dist/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });
    }

    const socket = new WebSocket(`wss://{{ MY_GLOBAL_VARIABLE }}/ws/positions/?user_id=${userId}`);

    socket.onopen = function () {
        console.log('WebSocket connect√© !');
        // Augmenter la barre de chargement √† 100% d√®s que WebSocket est connect√©
        document.querySelector('.load-bar').style.width = '100%'; 
    };

    socket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        const trackerId = data.tracker_id || 'default';
        const icon = getGreenIcon();

        if (trackerMarkers[trackerId]) {
            trackerMarkers[trackerId].setLatLng([data.latitude, data.longitude]);
            if (trackerMarkers[trackerId]._popup) {
                trackerMarkers[trackerId]._popup.setContent(`üêÑ B≈ìuf ${trackerId}`);
            }
        } else {
            const marker = L.marker([data.latitude, data.longitude], {
                icon: icon,
                riseOnHover: true
            }).addTo(map);

            marker.bindPopup(`üêÑ B≈ìuf ${trackerId}`, { autoPan: false });
            trackerMarkers[trackerId] = marker;
        }

        // Comment√© pour √©viter de forcer le zoom
        // map.setView([data.latitude, data.longitude], 14); 
    };

    socket.onerror = function (error) {
        console.error('WebSocket Error:', error);
    };

    socket.onclose = function (event) {
        console.warn('WebSocket ferm√©:', event.code);
    };

    // ----------------------------
    // Affichage des zones de s√©curit√©
    // ----------------------------
    const zonesData = JSON.parse('{{ zones_data_json|escapejs }}');

    zonesData.forEach(zone => {
        const forme = zone.forme;
        console.log('Traitement de la zone #', zone.id, zone);  // Debug log pour v√©rifier les donn√©es

        try {
            if (forme === 'polygon' && zone.coins) {
                const coords = zone.coins;
                if (coords && coords.length > 2) {
                    const latlngs = coords.map(pt => [pt[0], pt[1]]);
                    L.polygon(latlngs, {
                        color: 'green',
                        weight: 3,
                        fillOpacity: 0.2
                    }).addTo(map).bindPopup(`Zone #${zone.id} (Polygone)`);
                }
            } else if (forme === 'cercle' && zone.latitude && zone.longitude && zone.rayon) {
                L.circle([zone.latitude, zone.longitude], {
                    radius: zone.rayon,
                    color: 'blue',
                    weight: 3,
                    fillColor: 'blue',
                    fillOpacity: 0.1
                }).addTo(map).bindPopup(`Zone #${zone.id} (Cercle)`);
            } else if (forme === 'rectangle' && zone.coin1_lat) {
                const latlngs = [
                    [zone.coin1_lat, zone.coin1_lon],
                    [zone.coin2_lat, zone.coin2_lon],
                    [zone.coin3_lat, zone.coin3_lon],
                    [zone.coin4_lat, zone.coin4_lon],
                    [zone.coin1_lat, zone.coin1_lon]
                ];
                L.polygon(latlngs, {
                    color: 'orange',
                    weight: 3,
                    fillOpacity: 0.2
                }).addTo(map).bindPopup(`Zone #${zone.id} (Rectangle)`);
            } else {
                console.warn(`Zone #${zone.id} avec forme non trait√©e: ${forme}`);
            }
        } catch (e) {
            console.error(`Erreur lors du traitement de la zone #${zone.id}:`, e);
        }
    });
</script>



{% endblock %}
