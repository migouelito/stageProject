{% extends 'base/base.html' %}
{% load static %}

{% block content %}

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Statistiques des Capteurs</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #3a86ff;
            --secondary: #4cc9f0;
            --success: #38b000;
            --warning: #ffba08;
            --danger: #d90429;
            --dark: #2b2d42;
            --light: #f8f9fa;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #ebf4ff 100%);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: var(--bg-gradient);
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
        }
        .container-header {
            display: flex;
            align-items: center;
            justify-content: flex-start; /* aligne les éléments à gauche */
            gap: 15px; /* espacement entre l'icône et le titre */
            margin-bottom: 30px;
            padding: 15px 25px;
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }
        
        
        
        .container-header h2 {
            font-size: 1.8rem;
            color: #008000;
        
        }
        
        .container-header i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        .container-header::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 0%;
            height: 6px; /* plus épaisse */
            background-color: black; /* couleur noire */
            animation: loadBar 1.5s forwards;
        }
        
        
        @keyframes loadBar {
            0% { width: 0%; }
            100% { width: 100%; }
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 20px;
            display: flex;
            align-items: center;
            transition: transform 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            font-size: 1.5rem;
            color: white;
        }
        
        .active-icon {
            background-color: var(--success);
        }
        
        .inactive-icon {
            background-color: var(--danger);
        }
        
        .total-icon {
            background-color: var(--primary);
        }
        
        .stat-info h3 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 5px;
        }
        
        .stat-info p {
            color: #666;
            font-size: 1rem;
        }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
        }
        
        .chart-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: var(--shadow);
            padding: 25px;
            height: 400px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h3 {
            font-size: 1.2rem;
            color: var(--dark);
        }
        
        .chart-legend {
            display: flex;
            gap: 15px;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            font-size: 0.9rem;
        }
        
        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .chart-wrapper {
            position: relative;
            height: 100%;
            width: 100%;
        }
        
        @media (max-width: 768px) {
            .charts-container {
                grid-template-columns: 1fr;
            }
            
            .dashboard {
                grid-template-columns: 1fr;
            }
        }
    </style>

<body>
    <div class="container-header">
        <i class="fas fa-chart-pie"></i>
        <h2>Tableau de bord des statistiques</h2>
    </div>
    
    <div class="dashboard">
        <div class="stat-card">
            <div class="stat-icon active-icon">
                <i class="fas fa-power-off"></i>
            </div>
            <div class="stat-info">
                <h3 id="capteurs-actifs">0</h3>
                <p>Capteurs actifs</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon inactive-icon">
                <i class="fas fa-plug"></i>
            </div>
            <div class="stat-info">
                <h3 id="capteurs-inactifs">0</h3>
                <p>Capteurs inactifs</p>
            </div>
        </div>
        
        <div class="stat-card">
            <div class="stat-icon total-icon">
                <i class="fas fa-microchip"></i>
            </div>
            <div class="stat-info">
                <h3 id="capteurs-total">0</h3>
                <p>Total des capteurs</p>
            </div>
        </div>
    </div>
    
    <div class="charts-container">
        <div class="chart-container">
            <div class="chart-header">
                <h3>Répartition des capteurs par animal</h3>
            </div>
            <div class="chart-wrapper">
                <canvas id="pieChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container">
            <div class="chart-header">
                <h3>Nombre de capteurs par animal</h3>
            </div>
            <div class="chart-wrapper">
                <canvas id="barChart"></canvas>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function() {
            // Récupérer les données de l'utilisateur connecté depuis le contexte Django
            const capteursParAnimal = {
                {% for animal, count in capteurs_par_animal.items %}
                    "{{ animal }}": {{ count }},
                {% endfor %}
            };
            
            const capteursActifs = {{ capteurs_actifs }};
            const capteursInactifs = {{ capteurs_inactifs }};
            const capteursTotal = capteursActifs + capteursInactifs;
            
            // Mettre à jour les compteurs
            document.getElementById('capteurs-actifs').textContent = capteursActifs;
            document.getElementById('capteurs-inactifs').textContent = capteursInactifs;
            document.getElementById('capteurs-total').textContent = capteursTotal;
            
            // Filtrer pour ne garder que les animaux avec des capteurs
            const filteredCapteursParAnimal = {};
            for (const [animal, count] of Object.entries(capteursParAnimal)) {
                if (count > 0) {
                    filteredCapteursParAnimal[animal] = count;
                }
            }
            
            // Préparation des données pour les graphiques
            const labels = Object.keys(filteredCapteursParAnimal);
            const data = Object.values(filteredCapteursParAnimal);
            
            // Si aucune donnée, afficher un message
            if (data.length === 0) {
                document.querySelector('.charts-container').innerHTML = '<div class="no-data"><p>Aucune donnée disponible pour le moment</p></div>';
                return;
            }
            
            // Couleurs pour le graphique circulaire
            const backgroundColor = [
                '#3a86ff', // bleu
                '#8ac926', // vert
                '#ffbe0b', // jaune
                '#fb5607', // orange
                '#ff006e', // rose
                '#8338ec', // violet
                '#3a0ca3', // indigo
                '#4cc9f0'  // bleu clair
            ];
            
            // Graphique circulaire
            const ctxPie = document.getElementById('pieChart').getContext('2d');
            new Chart(ctxPie, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: '#ffffff',
                        borderWidth: 2,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                font: {
                                    size: 12
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const total = context.dataset.data.reduce((acc, val) => acc + val, 0);
                                    const percentage = Math.round((value / total) * 100);
                                    return `${label}: ${value} capteurs (${percentage}%)`;
                                }
                            }
                        }
                    },
                    cutout: '60%',
                    animation: {
                        animateScale: true,
                        animateRotate: true
                    }
                }
            });
            
            // Graphique en barres
            const ctxBar = document.getElementById('barChart').getContext('2d');
            new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nombre de capteurs',
                        data: data,
                        backgroundColor: backgroundColor,
                        borderColor: backgroundColor,
                        borderWidth: 1,
                        borderRadius: 6,
                        barThickness: 30,
                        maxBarThickness: 40
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.raw} capteurs`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                font: {
                                    size: 12
                                }
                            },
                            grid: {
                                display: true,
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            },
                            ticks: {
                                font: {
                                    size: 12
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            // Animation des compteurs
            function animateCounters() {
                const counters = document.querySelectorAll('.stat-info h3');
                counters.forEach(counter => {
                    const target = parseInt(counter.textContent);
                    let count = 0;
                    const duration = 1500; // ms
                    const frameDuration = 1000 / 60; // 60fps
                    const totalFrames = Math.round(duration / frameDuration);
                    const increment = target / totalFrames;
                    
                    const timer = setInterval(() => {
                        count += increment;
                        if (count >= target) {
                            counter.textContent = target;
                            clearInterval(timer);
                        } else {
                            counter.textContent = Math.floor(count);
                        }
                    }, frameDuration);
                });
            }
            
            // Démarrer l'animation des compteurs
            animateCounters();
        });
    </script>
</body>
{% endblock %}